<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­å¥åº·è¡€å£“ç«™</title>
    <meta name="description" content="æº«é¦¨çš„å®¶åº­è¡€å£“ç´€éŒ„ Appï¼Œæ—¥ç³»é›œèªŒé¢¨æ ¼ï¼Œå®ˆè­·å…¨å®¶äººçš„å¿ƒè¡€ç®¡å¥åº·ã€‚">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* é è¨­è®Šæ•¸ (æœƒé€é JS å‹•æ…‹åˆ‡æ›) */
            --theme-color: #728FCE;  /* ä¸»é¡Œè‰² */
            --bg-color: #FDFCF8;     /* ç±³è‰²ç´™è³ªæ„ŸèƒŒæ™¯ */
            --card-bg: #FFFFFF;
            --text-color: #595757;   /* æ·±ç°è€Œéç´”é»‘ï¼Œè¼ƒæŸ”å’Œ */
            --border-style: 2px dashed var(--theme-color); /* è™›ç·šé‚Šæ¡† */
        }

        body {
            font-family: "Kiwi Maru", "Microsoft JhengHei", serif; /* å¥—ç”¨å­—é«” */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--theme-color) 0.5px, transparent 0.5px); /* é»é»èƒŒæ™¯ */
            background-size: 20px 20px; /* é»é»é–“è· */
            color: var(--text-color);
            transition: background-color 0.5s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 600px; /* ç¨å¾®ç¸®çª„ä¸€é»ï¼Œæ›´æœ‰é›œèªŒæ’ç‰ˆæ„Ÿ */
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Header å€å¡Š */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: var(--border-style);
        }

        h1 {
            color: var(--theme-color);
            margin: 10px 0;
            font-size: 1.6rem;
            letter-spacing: 2px;
        }

        .role-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 5px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* è§’è‰²åˆ‡æ›æŒ‰éˆ•å€ */
        .role-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .role-btn {
            border: 2px solid var(--theme-color);
            background: white;
            color: var(--text-color);
            border-radius: 15px;
            cursor: pointer;
            font-family: "Kiwi Maru";
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1); /* å¯æ„›ç¡¬é™°å½± */
        }

        .role-btn:hover { transform: translateY(-2px); }
        .role-btn.active {
            background: var(--theme-color);
            color: white;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }

        /* çˆ¸çˆ¸åª½åª½ï¼šå¤§æŒ‰éˆ• */
        .btn-large {
            padding: 12px 30px;
            font-size: 1.1rem;
            flex: 1; /* å¹³å‡åˆ†é…å¯¬åº¦ */
        }

        /* å°å­©ï¼šå°æŒ‰éˆ• */
        .btn-small {
            padding: 8px 15px;
            font-size: 0.95rem;
            flex: 1;
        }

        /* å¡ç‰‡å…±ç”¨æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        
        /* è£é£¾æ€§çš„å°æ¨™ç±¤ (Tape effect) */
        .card::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 25px;
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
        }

        /* è¼¸å…¥è¡¨å–®å„ªåŒ– */
        .input-group { 
            margin-bottom: 25px; /* åŠ å¤§é–“è· (éœ€æ±‚2) */
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: var(--theme-color);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        input, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #fafafa;
            color: #555;
            font-family: "Kiwi Maru";
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--theme-color);
            background-color: white;
        }

        .bp-inputs { display: flex; gap: 20px; }
        .bp-inputs div { flex: 1; }

        button.submit-btn {
            width: 100%;
            padding: 16px;
            background-color: var(--theme-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            font-family: "Kiwi Maru";
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }

        button.submit-btn:active { transform: scale(0.98); }

        /* æº«é¦¨æç¤ºå€ */
        .tips {
            background-color: #fff;
            border: 2px dashed var(--theme-color);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            position: relative;
        }
        
        .tips h3 {
            color: var(--theme-color);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* åœ–è¡¨ç¯©é¸å™¨ */
        .filter-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            align-items: center;
            gap: 10px;
        }
        
        .filter-select {
            width: auto;
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 20px;
            border: 1px solid var(--theme-color);
            color: var(--theme-color);
            background: white;
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            color: white;
            font-weight: normal;
            font-size: 0.9rem;
            margin-left: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        footer {
            text-align: center;
            margin-top: 50px;
            font-size: 0.85rem;
            color: #999;
        }
        
        footer a { color: var(--theme-color); text-decoration: none; border-bottom: 1px dotted; }

        /* è£é£¾å°æ’åœ– (CSSç¹ªè£½æˆ–Emoji) */
        .cute-deco {
            position: absolute;
            opacity: 0.1;
            z-index: 0;
            pointer-events: none;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="role-icon" id="headerIcon">ğŸ‘”</div>
        <h1 id="headerTitle">çˆ¸çˆ¸çš„å¥åº·æ—¥è¨˜</h1>
        
        <div class="role-group">
            <button class="role-btn btn-large active" onclick="setRole('çˆ¸çˆ¸')">çˆ¸çˆ¸</button>
            <button class="role-btn btn-large" onclick="setRole('åª½åª½')">åª½åª½</button>
        </div>
        <div class="role-group">
            <button class="role-btn btn-small" onclick="setRole('å¤§å¥³å…’')">å¤§å¥³å…’</button>
            <button class="role-btn btn-small" onclick="setRole('å…’å­')">å…’å­</button>
            <button class="role-btn btn-small" onclick="setRole('å°å¥³å…’')">å°å¥³å…’</button>
        </div>
    </header>

    <section class="card">
        <div class="input-group">
            <label>ğŸ“… æ¸¬é‡æ—¥æœŸ</label>
            <input type="date" id="recordDate">
        </div>

        <div class="input-group">
            <label>â° æ¸¬é‡æ™‚æ®µ</label>
            <select id="recordTime">
                <option value="æ—©ä¸Š">â˜€ï¸ æ—©ä¸Š (èµ·åºŠå¾Œ)</option>
                <option value="æ™šä¸Š">ğŸŒ™ æ™šä¸Š (ç¡å‰)</option>
            </select>
        </div>

        <div class="bp-inputs">
            <div class="input-group">
                <label>æ”¶ç¸®å£“ (é«˜)</label>
                <input type="number" id="sysVal" placeholder="120" inputmode="numeric">
            </div>
            <div class="input-group">
                <label>èˆ’å¼µå£“ (ä½)</label>
                <input type="number" id="diaVal" placeholder="80" inputmode="numeric">
            </div>
        </div>

        <button class="submit-btn" onclick="saveData()">âœ¨ è¨˜éŒ„ä»Šå¤©æ•¸å€¼</button>

        <div class="tips">
            <h3>ğŸµ å¥åº·å°è²¼å£«</h3>
            <ul style="padding-left: 20px; line-height: 1.8; color: #666;">
                <li><strong>722 åŸå‰‡ï¼š</strong>é€£çºŒ 7 å¤©ã€æ—©æ™šå„é‡ 2 æ¬¡ã€æ¯æ¬¡é‡ 2 éå–å¹³å‡ã€‚</li>
                <li>é‡æ¸¬å‰æ·±å‘¼å¸ï¼Œä¼‘æ¯ 5 åˆ†é˜ã€‚</li>
                <li><a href="https://www.hpa.gov.tw/Pages/List.aspx?nodeid=214" target="_blank">é»æ­¤æŸ¥çœ‹è¡›ç¦éƒ¨æ›´è©³ç´°çš„è¡›æ•™è³‡è¨Š</a></li>
            </ul>
        </div>
    </section>

    <section class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 1.3rem; color: var(--theme-color);">ğŸ“ˆ è¶¨å‹¢è®ŠåŒ–</h2>
            
            <div class="filter-container">
                <select id="timeRange" class="filter-select" onchange="filterAndRender()">
                    <option value="7">è¿‘ 1 é€±</option>
                    <option value="30">è¿‘ 1 å€‹æœˆ</option>
                    <option value="90">è¿‘ 3 å€‹æœˆ</option>
                </select>
            </div>
        </div>

        <div style="height: 300px; width: 100%;">
            <canvas id="bpChart"></canvas>
        </div>

        <div id="analysisResult" style="margin-top: 20px; padding: 15px; background: #fafafa; border-radius: 10px;">
            <p>â˜ï¸ è³‡æ–™è®€å–ä¸­...</p>
        </div>
    </section>

    <footer>
        Designed with â¤ï¸ for Family
    </footer>
</div>

<script>
    // ==========================================
    // âš ï¸ è¨­å®šå€ï¼šè«‹ç¢ºèªé€™æ˜¯æ‚¨çš„ Zeabur API
    // ==========================================
    const API_BASE_URL = 'https://family-health.zeabur.app/api/records'; 

    // --- 1. å®šç¾©è§’è‰²ä¸»é¡Œè¨­å®š (éœ€æ±‚4) ---
    const ROLE_THEMES = {
        'çˆ¸çˆ¸': { color: '#728FCE', icon: 'ğŸ‘”', title: 'çˆ¸çˆ¸çš„å¥åº·æ—¥è¨˜', bgPattern: 'radial-gradient(#728FCE 0.5px, transparent 0.5px)' },
        'åª½åª½': { color: '#E5989B', icon: 'ğŸŒ¸', title: 'åª½åª½çš„å¥åº·æ—¥è¨˜', bgPattern: 'radial-gradient(#E5989B 0.5px, transparent 0.5px)' },
        'å¤§å¥³å…’': { color: '#F4D35E', icon: 'ğŸ€', title: 'å¤§å¥³å…’çš„ç´€éŒ„', bgPattern: 'radial-gradient(#F4D35E 0.5px, transparent 0.5px)' },
        'å…’å­': { color: '#83BCA9', icon: 'ğŸ§¢', title: 'å…’å­çš„ç´€éŒ„', bgPattern: 'radial-gradient(#83BCA9 0.5px, transparent 0.5px)' },
        'å°å¥³å…’': { color: '#B79CED', icon: 'ğŸ§¸', title: 'å°å¥³å…’çš„ç´€éŒ„', bgPattern: 'radial-gradient(#B79CED 0.5px, transparent 0.5px)' }
    };

    let currentRole = 'çˆ¸çˆ¸';
    let allData = []; // å„²å­˜æŠ“å›ä¾†çš„åŸå§‹è³‡æ–™ï¼Œä¾›ç¯©é¸ç”¨
    let myChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('recordDate').valueAsDate = new Date();
        applyTheme('çˆ¸çˆ¸'); // åˆå§‹åŒ–ä¸»é¡Œ
        fetchData();
    });

    // --- åˆ‡æ›è§’è‰²èˆ‡ä¸»é¡Œ ---
    function setRole(role) {
        currentRole = role;
        applyTheme(role);
        fetchData();
    }

    function applyTheme(role) {
        const theme = ROLE_THEMES[role];
        const root = document.documentElement;

        // 1. è¨­å®š CSS è®Šæ•¸
        root.style.setProperty('--theme-color', theme.color);
        
        // 2. æ›´æ–°ç•«é¢å…ƒç´ 
        document.getElementById('headerIcon').innerText = theme.icon;
        document.getElementById('headerTitle').innerText = theme.title;
        
        // 3. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.innerText === role) btn.classList.add('active');
        });
    }

    // --- API äº’å‹• ---
    async function saveData() {
        const date = document.getElementById('recordDate').value;
        const time = document.getElementById('recordTime').value;
        const sys = document.getElementById('sysVal').value;
        const dia = document.getElementById('diaVal').value;
        const btn = document.querySelector('.submit-btn');

        if(!sys || !dia) {
            alert('è¨˜å¾—è¼¸å…¥æ•¸å€¼å–”ï¼');
            return;
        }

        btn.innerText = 'ğŸˆ åŠªåŠ›å¯«å…¥ä¸­...';
        btn.disabled = true;

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: currentRole, date, time, sys, dia })
            });

            if (!response.ok) throw new Error('Error');

            alert('âœ… ç´€éŒ„å®Œæˆï¼ç¹¼çºŒä¿æŒå¥åº·å–”ï¼');
            document.getElementById('sysVal').value = '';
            document.getElementById('diaVal').value = '';
            fetchData(); 

        } catch (error) {
            alert('âŒ ç³Ÿç³•ï¼Œç¶²è·¯æœ‰é»å•é¡Œ');
        } finally {
            btn.innerText = 'âœ¨ è¨˜éŒ„ä»Šå¤©æ•¸å€¼';
            btn.disabled = false;
        }
    }

    async function fetchData() {
        const analysisDiv = document.getElementById('analysisResult');
        analysisDiv.innerHTML = '<p>â˜ï¸ è³‡æ–™è®€å–ä¸­...</p>';

        try {
            const response = await fetch(`${API_BASE_URL}?name=${encodeURIComponent(currentRole)}`);
            if (!response.ok) throw new Error('Fetch error');

            allData = await response.json(); // å­˜å…¥å…¨åŸŸè®Šæ•¸
            
            // å‘¼å«ç¯©é¸èˆ‡ç¹ªåœ–åŠŸèƒ½
            filterAndRender();

        } catch (error) {
            console.error(error);
            analysisDiv.innerHTML = '<p>ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦æ­£å¸¸é‹ä½œã€‚</p>';
        }
    }

    // --- ç¯©é¸è³‡æ–™ (è¿‘1é€±/1æœˆ/3æœˆ) ---
    function filterAndRender() {
        const range = parseInt(document.getElementById('timeRange').value);
        
        // å¦‚æœå¾Œç«¯é‚„æ²’æ”¹æ‰ .slice(-10)ï¼Œé€™è£¡æœ€å¤šåªæœƒé¡¯ç¤º 10 ç­†ï¼Œ
        // ä½†é‚è¼¯ä¸Šæˆ‘å€‘æœƒå˜—è©¦éæ¿¾æ—¥æœŸ
        
        const now = new Date();
        const cutoffDate = new Date();
        cutoffDate.setDate(now.getDate() - range);

        // éæ¿¾è³‡æ–™ (å‡è¨­å¾Œç«¯å›å‚³çš„ date æ ¼å¼æ˜¯ YYYY-MM-DD)
        const filteredData = allData.filter(d => {
            const recordDate = new Date(d.date);
            return recordDate >= cutoffDate;
        });

        // å¦‚æœéæ¿¾å¾Œè³‡æ–™å¤ªå°‘ï¼Œç‚ºäº†åœ–è¡¨å¥½çœ‹ï¼Œé‚„æ˜¯é¡¯ç¤ºåŸå§‹è³‡æ–™çš„æœ€å¾Œå¹¾ç­† (é˜²å‘†)
        const displayData = filteredData.length > 0 ? filteredData : allData.slice(-range); // ç°¡å–® fallback

        renderChart(displayData);
        analyzeHealth(displayData);
    }

    // --- ç¹ªåœ–è¨­å®š (æ—¥ç³»æŸ”å’Œé…è‰²) ---
    function renderChart(data) {
        const ctx = document.getElementById('bpChart').getContext('2d');
        const theme = ROLE_THEMES[currentRole]; // å–å¾—ç›®å‰ä¸»é¡Œè‰²

        if(data.length === 0) {
            if(myChart) myChart.destroy();
            return;
        }

        const labels = data.map(d => {
            // è‡ªå‹•åµæ¸¬æ—¥æœŸæ ¼å¼
            const dateObj = new Date(d.date);
            
            // å¦‚æœæ—¥æœŸè®€ä¸åˆ°ï¼Œå°±ç›´æ¥é¡¯ç¤ºåŸå§‹æ–‡å­— (é˜²å‘†)
            if (isNaN(dateObj.getTime())) return d.date; 
            
            // æ ¼å¼åŒ–æˆ "æœˆ/æ—¥" (ä¾‹å¦‚ 12/7)
            return `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
        });
        
        const sysData = data.map(d => d.sys);
        const diaData = data.map(d => d.dia);

        if(myChart) myChart.destroy();

        // è¨­å®š Chart.js å…¨åŸŸå­—é«”
        Chart.defaults.font.family = "'Kiwi Maru', 'Microsoft JhengHei'";

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ”¶ç¸®å£“',
                        data: sysData,
                        borderColor: theme.color, // ä½¿ç”¨ä¸»é¡Œè‰²
                        backgroundColor: theme.color, 
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        borderWidth: 2,
                        tension: 0.4, // æŸ”å’Œæ›²ç·š
                    },
                    {
                        label: 'èˆ’å¼µå£“',
                        data: diaData,
                        borderColor: '#aaa', // èˆ’å¼µå£“ç”¨ç°è‰²é™ªè¥¯
                        borderDash: [5, 5],  // è™›ç·š
                        pointRadius: 0,      // ä¸é¡¯ç¤ºé»
                        borderWidth: 2,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { usePointStyle: true, boxWidth: 8 }
                    }
                },
                scales: {
                    x: { grid: { display: false } }, // éš±è— X è»¸ç¶²æ ¼ï¼Œæ›´ä¹¾æ·¨
                    y: { 
                        beginAtZero: false, 
                        grid: { color: '#f0f0f0' },
                        suggestedMin: 60,
                        suggestedMax: 160
                    }
                }
            }
        });
    }

    function analyzeHealth(data) {
        if (!data || data.length === 0) {
            document.getElementById('analysisResult').innerHTML = '<p>ç›®å‰å€é–“ç„¡è³‡æ–™ã€‚</p>';
            return;
        }

        let totalSys = 0, totalDia = 0;
        data.forEach(d => {
            totalSys += parseInt(d.sys);
            totalDia += parseInt(d.dia);
        });
        const avgSys = Math.round(totalSys / data.length);
        const avgDia = Math.round(totalDia / data.length);

        let status = 'æ­£å¸¸';
        let color = '#83BCA9'; 
        let advice = 'å¾ˆæ£’å–”ï¼ç¹¼çºŒä¿æŒå¹³éœçš„å¿ƒæƒ…ã€‚';

        if (avgSys >= 130 || avgDia >= 80) {
            status = 'æ³¨æ„';
            color = '#F4D35E'; 
            advice = 'ç¨å¾®åé«˜å›‰ï¼Œé€™å¹¾å¤©è¨˜å¾—å°‘åƒé¹¹çš„ã€‚';
        }
        if (avgSys >= 140 || avgDia >= 90) {
            status = 'éé«˜';
            color = '#E5989B';
            advice = 'è¡€å£“æœ‰é»é«˜ï¼Œå»ºè­°æ‰¾é†«ç”ŸèŠèŠå–”ã€‚';
        }

        document.getElementById('analysisResult').innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="margin:0; color: ${color}">å¹³å‡ ${avgSys} / ${avgDia}</h3>
                    <small style="color: #888">å€é–“å¹³å‡å€¼</small>
                </div>
                <span class="status-badge" style="background-color: ${color}">${status}</span>
            </div>
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 10px 0;">
            <p style="margin:0; color: #666;">ğŸ“ ${advice}</p>
        `;
    }
</script>

</body>
</html>