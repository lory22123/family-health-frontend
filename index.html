<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶åº­è¡€å£“">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>å®¶åº­å¥åº·è¡€å£“ç«™ - å…¨å®¶äººçš„å¿ƒè¡€ç®¡å®ˆè­·è€…</title>
    <meta name="description" content="å°ˆç‚ºå®¶åº­è¨­è¨ˆçš„è¡€å£“ç´€éŒ„æ‡‰ç”¨ç¨‹å¼ï¼Œä¸²æ¥é›²ç«¯è³‡æ–™åº«ï¼Œæä¾›æ—©æ™šæ¸¬é‡è¨˜éŒ„ã€è¶¨å‹¢åœ–è¡¨åˆ†æåŠå°ˆæ¥­å¥åº·å»ºè­°ã€‚">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e74c3c;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* éŸ¿æ‡‰å¼å®¹å™¨ - è§£æ±º 320px/768px/1440px å¯¬åº¦å•é¡Œ */
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Hero å€ & æ¨™é¡Œ */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary-color);
            margin: 10px 0;
            font-size: 1.8rem;
        }

        /* è§’è‰²åˆ‡æ›æŒ‰éˆ• */
        .role-selector {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .role-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary-color);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .role-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        /* è¼¸å…¥è¡¨å–® */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .bp-inputs { display: flex; gap: 15px; }
        .bp-inputs div { flex: 1; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button.submit-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.3s;
        }

        button.submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        button.submit-btn:hover:not(:disabled) {
            background-color: #c0392b;
        }

        /* æç¤ºèˆ‡åˆ†æ */
        .tips {
            background-color: #e8f6f3;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #2c3e50;
            margin-top: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .analysis-box {
            background-color: #fdf2e9;
            border-left: 5px solid #d35400;
            padding: 15px;
            margin-top: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            font-size: 0.8rem;
            color: #666;
        }
        
        /* é‡å°å°è¢å¹•å„ªåŒ– */
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .card { padding: 15px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <img src="https://cdn-icons-png.flaticon.com/512/2966/2966486.png" alt="å¿ƒè‡Ÿå¥åº·åœ–ç¤º" width="60" height="60">
        <h1>å®¶åº­è¡€å£“å¥åº·ç«™</h1>
        
        <div class="role-selector">
            <button class="role-btn active" onclick="setRole('çˆ¸çˆ¸')">çˆ¸çˆ¸</button>
            <button class="role-btn" onclick="setRole('åª½åª½')">åª½åª½</button>
            <button class="role-btn" onclick="setRole('å¤§å¥³å…’')">å¤§å¥³å…’</button>
            <button class="role-btn" onclick="setRole('å…’å­')">å…’å­</button>
            <button class="role-btn" onclick="setRole('å°å¥³å…’')">å°å¥³å…’</button>
        </div>
    </header>

    <section class="card">
        <div class="input-group">
            <label for="recordDate">æ¸¬é‡æ—¥æœŸ</label>
            <input type="date" id="recordDate">
        </div>

        <div class="input-group">
            <label for="recordTime">æ¸¬é‡æ™‚æ®µ</label>
            <select id="recordTime">
                <option value="æ—©ä¸Š">æ—©ä¸Š (èµ·åºŠå¾Œ1å°æ™‚å…§)</option>
                <option value="æ™šä¸Š">æ™šä¸Š (ç¡å‰1å°æ™‚å…§)</option>
            </select>
        </div>

        <div class="bp-inputs">
            <div class="input-group">
                <label for="sysVal">æ”¶ç¸®å£“ (é«˜)</label>
                <input type="number" id="sysVal" placeholder="mmHg" inputmode="numeric">
            </div>
            <div class="input-group">
                <label for="diaVal">èˆ’å¼µå£“ (ä½)</label>
                <input type="number" id="diaVal" placeholder="mmHg" inputmode="numeric">
            </div>
        </div>

        <button class="submit-btn" onclick="saveData()">ç¢ºèªç´€éŒ„</button>

        <div class="tips">
            <h3>ğŸ‘¨â€âš•ï¸ æ¸¬é‡å°å®åš€ (722åŸå‰‡)</h3>
            <ul>
                <li>é‡æ¸¬å‰ä¼‘æ¯ 5 åˆ†é˜ï¼Œä¿æŒå¹³éœã€‚</li>
                <li>æ‰‹è‡‚èˆ‡å¿ƒè‡ŸåŒé«˜ï¼Œä¸èªªè©±ã€ä¸ç¿¹è…³ã€‚</li>
                <li>æ—©æ™šå„é‡ 2 æ¬¡ï¼Œå–å¹³å‡å€¼ç´€éŒ„ã€‚</li>
            </ul>
        </div>
    </section>

    <hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">

    <section class="card">
        <h2>ğŸ“Š è¿‘ 10 å¤©è¶¨å‹¢åœ–</h2>
        <div class="chart-container">
            <canvas id="bpChart"></canvas>
        </div>

        <div class="analysis-box" id="analysisResult">
            <p>æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
        </div>
    </section>

    <footer>
        <p>ç³»çµ±æ¶æ§‹ï¼šNode.js (Zeabur) + Google Sheets</p>
        <a href="https://www.hpa.gov.tw/Pages/List.aspx?nodeid=214" target="_blank">è¡›ç”Ÿç¦åˆ©éƒ¨é«˜è¡€å£“é˜²æ²»è³‡è¨Š</a>
    </footer>
</div>

<script>
    // ==========================================
    // âš ï¸ è¨­å®šå€ï¼šè«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ Zeabur ç¶²å€
    // ä¾‹å¦‚ï¼š'https://family-health.zeabur.app/api/records'
    // ==========================================
    const API_BASE_URL = 'https://family-health.zeabur.app/api/records'; 

    let currentRole = 'çˆ¸çˆ¸';
    let myChart = null;

    // åˆå§‹åŒ–ï¼šè¨­å®šæ—¥æœŸç‚ºä»Šå¤©ï¼Œä¸¦è®€å–è³‡æ–™
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('recordDate').valueAsDate = new Date();
        fetchData();
    });

    // åˆ‡æ›è§’è‰²
    function setRole(role) {
        currentRole = role;
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.innerText === role) btn.classList.add('active');
        });
        // åˆ‡æ›å¾Œè‡ªå‹•é‡æ–°è®€å–è³‡æ–™
        fetchData();
    }

    // 1. å„²å­˜è³‡æ–™ (POST åˆ° Node.js)
    async function saveData() {
        const date = document.getElementById('recordDate').value;
        const time = document.getElementById('recordTime').value;
        const sys = document.getElementById('sysVal').value;
        const dia = document.getElementById('diaVal').value;
        const btn = document.querySelector('.submit-btn');

        if(!sys || !dia) {
            alert('è«‹è¼¸å…¥å®Œæ•´çš„æ”¶ç¸®å£“èˆ‡èˆ’å¼µå£“æ•¸å€¼');
            return;
        }

        // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡ç™¼é€
        btn.innerText = 'è³‡æ–™å¯«å…¥ä¸­...';
        btn.disabled = true;

        const payload = {
            name: currentRole,
            date: date,
            time: time,
            sys: sys,
            dia: dia
        };

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // å‘Šè¨´ Node.js é€™æ˜¯ JSON
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤');

            const result = await response.json();
            alert('âœ… ç´€éŒ„æˆåŠŸï¼');
            
            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            document.getElementById('sysVal').value = '';
            document.getElementById('diaVal').value = '';
            
            // é‡æ–°è®€å–åœ–è¡¨
            fetchData(); 

        } catch (error) {
            console.error('Error:', error);
            alert('âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ä¼ºæœå™¨ç‹€æ…‹');
        } finally {
            btn.innerText = 'ç¢ºèªç´€éŒ„';
            btn.disabled = false;
        }
    }

    // 2. è®€å–è³‡æ–™ (GET å¾ Node.js)
    async function fetchData() {
        const analysisDiv = document.getElementById('analysisResult');
        analysisDiv.innerHTML = '<p>ğŸ”„ è³‡æ–™è®€å–ä¸­...</p>';

        try {
            // å‘¼å« Zeabur API
            const response = await fetch(`${API_BASE_URL}?name=${encodeURIComponent(currentRole)}`);
            if (!response.ok) throw new Error('è®€å–å¤±æ•—');

            const data = await response.json();
            
            // ç¹ªåœ–èˆ‡åˆ†æ
            renderChart(data);
            analyzeHealth(data);

        } catch (error) {
            console.error('Error:', error);
            analysisDiv.innerHTML = '<p style="color:red">ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨æ˜¯å¦å•Ÿå‹•ã€‚</p>';
        }
    }

    // 3. Chart.js ç¹ªåœ–é‚è¼¯
    function renderChart(data) {
        const ctx = document.getElementById('bpChart').getContext('2d');
        
        // å¦‚æœæ²’è³‡æ–™ï¼Œæ¸…ç©ºåœ–è¡¨
        if (data.length === 0) {
            if(myChart) myChart.destroy();
            return;
        }

        const labels = data.map(d => {
            // ç°¡å–®è™•ç†æ—¥æœŸæ ¼å¼ï¼Œåªé¡¯ç¤º æœˆ/æ—¥
            const dateParts = d.date.split('-'); // å‡è¨­å¾Œç«¯å›å‚³ YYYY-MM-DD
            const shortDate = dateParts.length > 1 ? `${dateParts[1]}/${dateParts[2]}` : d.date;
            return `${shortDate} (${d.time})`;
        });

        const sysData = data.map(d => d.sys);
        const diaData = data.map(d => d.dia);

        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ”¶ç¸®å£“',
                        data: sysData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.2,
                        fill: true
                    },
                    {
                        label: 'èˆ’å¼µå£“',
                        data: diaData,
                        borderColor: '#2980b9',
                        backgroundColor: 'rgba(41, 128, 185, 0.1)',
                        tension: 0.2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        suggestedMin: 60,
                        suggestedMax: 160
                    }
                }
            }
        });
    }

    // 4. å¥åº·æ•¸å€¼åˆ†æ
    function analyzeHealth(data) {
        if (!data || data.length === 0) {
            document.getElementById('analysisResult').innerHTML = '<p>å°šç„¡ç´€éŒ„ï¼Œè«‹è¼¸å…¥ç¬¬ä¸€ç­†è³‡æ–™ã€‚</p>';
            return;
        }

        let totalSys = 0, totalDia = 0;
        data.forEach(d => {
            totalSys += parseInt(d.sys);
            totalDia += parseInt(d.dia);
        });
        const avgSys = Math.round(totalSys / data.length);
        const avgDia = Math.round(totalDia / data.length);

        // åˆ¤æ–·é‚è¼¯
        let status = 'æ­£å¸¸';
        let color = '#27ae60'; 
        let advice = 'ç¶­æŒå¾—å¾ˆå¥½ï¼';

        if (avgSys >= 140 || avgDia >= 90) {
            status = 'é«˜è¡€å£“è­¦ç¤º';
            color = '#c0392b'; // ç´…è‰²
            advice = 'æ•¸å€¼åé«˜ï¼Œå»ºè­°å°±é†«è«®è©¢ï¼Œä¸¦æ³¨æ„é£²é£Ÿæ¸›é¹½ã€‚';
        } else if (avgSys >= 130 || avgDia >= 80) {
            status = 'è¡€å£“åé«˜';
            color = '#e67e22'; // æ©˜è‰²
            advice = 'å·²é”è­¦æˆ’å€¼ï¼Œè«‹é–‹å§‹æ³¨æ„ç”Ÿæ´»ä½œæ¯èˆ‡é‹å‹•ã€‚';
        }

        document.getElementById('analysisResult').innerHTML = `
            <h3>${currentRole} çš„å¥åº·å ±å‘Š (è¿‘ ${data.length} ç­†å¹³å‡)</h3>
            <p style="font-size: 1.1rem;">
                å¹³å‡è¡€å£“ï¼š<strong>${avgSys} / ${avgDia}</strong> mmHg 
                <span class="status-badge" style="background-color: ${color}">${status}</span>
            </p>
            <p>ğŸ‘¨â€âš•ï¸ <strong>å»ºè­°ï¼š</strong> ${advice}</p>
        `;
    }
</script>

</body>
</html>