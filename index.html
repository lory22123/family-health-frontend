<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­å¥åº·è¡€å£“ç«™</title>
    <meta name="description" content="æº«é¦¨çš„å®¶åº­è¡€å£“ç´€éŒ„ Appï¼Œæ—¥ç³»é›œèªŒé¢¨æ ¼ï¼Œå®ˆè­·å…¨å®¶äººçš„å¿ƒè¡€ç®¡å¥åº·ã€‚">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶åº­è¡€å£“">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* ğŸ¨ é…è‰²å„ªåŒ–ï¼šå¢å¼·å°æ¯” */
            --theme-color: #728FCE;  
            --bg-color: #F2EFE9;     /* èƒŒæ™¯æ”¹æ·±ä¸€é»çš„å¥¶èŒ¶è‰²ï¼Œå°æ¯”ç™½è‰²å¡ç‰‡æ›´æ˜é¡¯ */
            --card-bg: #FFFFFF;
            --text-color: #4A4A4A;   /* å­—é«”åŠ æ·±ï¼Œé–±è®€æ›´æ¸…æ™° */
            --input-border: #D1D1D1; /* è¼¸å…¥æ¡†é‚Šæ¡†åŠ æ·± */
        }

        body {
            font-family: "Kiwi Maru", "Microsoft JhengHei", serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            /* èƒŒæ™¯é»é»ç¨å¾®åŠ æ·±ï¼Œå¢åŠ è³ªæ„Ÿ */
            background-image: radial-gradient(#d0c9c0 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-color);
            transition: background-color 0.5s, color 0.3s;
            /* é˜²æ­¢ iOS é»æ“Šé«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 40px; /* é¿é–‹ iOS ç€æµ· */
            box-sizing: border-box;
        }

        /* Header å€å¡Š */
        header {
            text-align: center;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95); /* ä¸é€æ˜åº¦æé«˜ */
            border-radius: 24px;
            /* å¢åŠ ç«‹é«”é™°å½± */
            box-shadow: 0 8px 20px rgba(114, 143, 206, 0.15); 
            border: 2px dashed var(--theme-color);
        }

        h1 {
            color: var(--theme-color);
            margin: 10px 0;
            font-size: 1.7rem;
            letter-spacing: 1.5px;
            text-shadow: 1px 1px 0px rgba(255,255,255,1);
        }

        .role-icon {
            font-size: 3.5rem;
            display: block;
            margin-bottom: 5px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); /* Icon ä¹Ÿæœ‰é™°å½± */
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* è§’è‰²åˆ‡æ›æŒ‰éˆ•å€ */
        .role-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 12px;
        }

        .role-btn {
            border: 2px solid var(--theme-color);
            background: #fff;
            color: var(--text-color);
            border-radius: 16px;
            cursor: pointer;
            font-family: "Kiwi Maru";
            font-weight: bold;
            transition: all 0.2s;
            /* æŒ‰éˆ•é™°å½±åŠ æ·±ï¼Œçœ‹èµ·ä¾†åƒå¯¦é«”æŒ‰éˆ• */
            box-shadow: 0 4px 0px rgba(0,0,0,0.1); 
        }

        .role-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }

        .role-btn.active {
            background: var(--theme-color);
            color: white;
            box-shadow: 0 4px 0px rgba(0,0,0,0.2); /* ä½œç”¨ä¸­çš„æŒ‰éˆ•é™°å½±æ›´æ·± */
            border-color: var(--theme-color);
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 1.1rem;
            flex: 1;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.95rem;
            flex: 1;
        }

        /* å¡ç‰‡å…±ç”¨æ¨£å¼ - é€™æ˜¯é€™æ¬¡æ”¹æœ€å¤§çš„åœ°æ–¹ */
        .card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 30px 25px;
            /* é‡é»ï¼šåŠ å¼·é™°å½±ï¼Œè®“å¡ç‰‡æµ®èµ·ä¾† */
            box-shadow: 0 12px 24px rgba(100, 100, 100, 0.12), 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            position: relative;
            overflow: visible; /* è®“ tape ä¸æœƒè¢«åˆ‡æ‰ */
            border: 1px solid rgba(0,0,0,0.02); /* æ¥µç´°å¾®é‚Šæ¡†å¢åŠ é‚Šç·£æ¸…æ™°åº¦ */
        }
        
        /* ç´™è† å¸¶æ•ˆæœ */
        .card::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(-1deg);
            width: 110px;
            height: 28px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            z-index: 1;
            /* å…©ç«¯é‹¸é½’ç‹€ */
            clip-path: polygon(2% 0%, 98% 0%, 100% 100%, 0% 100%);
        }

        .input-group { margin-bottom: 25px; }
        
        label { 
            display: block; 
            margin-bottom: 10px; 
            color: var(--theme-color);
            font-weight: 900; /* å­—é«”åŠ ç²— */
            font-size: 1.15rem;
        }
        
        /* è¼¸å…¥æ¡†æ¨£å¼å„ªåŒ– */
        input, select {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--input-border); /* é‚Šæ¡†åŠ æ·± */
            border-radius: 14px;
            box-sizing: border-box;
            font-size: 1.1rem; /* å­—é«”åŠ å¤§ */
            background-color: #fff; /* ç´”ç™½èƒŒæ™¯ */
            color: #333;
            font-family: "Kiwi Maru";
            transition: all 0.3s;
            /* è¼¸å…¥æ¡†å…§é™°å½±ï¼Œå¢åŠ å‡¹é™·æ„Ÿ */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
            -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­æ¨£å¼ */
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 4px rgba(114, 143, 206, 0.2); /* èšç„¦å…‰æšˆ */
        }

        .bp-inputs { display: flex; gap: 15px; }
        .bp-inputs div { flex: 1; }

        button.submit-btn {
            width: 100%;
            padding: 18px;
            background-color: var(--theme-color);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.25rem;
            cursor: pointer;
            font-family: "Kiwi Maru";
            margin-top: 15px;
            box-shadow: 0 6px 15px rgba(114, 143, 206, 0.4); /* æŒ‰éˆ•ç™¼å…‰æ„Ÿ */
            transition: transform 0.1s;
            font-weight: bold;
        }

        button.submit-btn:active { transform: scale(0.96); }

        .tips {
            background-color: #F8F9FA;
            border: 2px dashed var(--theme-color);
            padding: 20px;
            border-radius: 16px;
            margin-top: 30px;
        }
        
        .tips h3 {
            color: var(--theme-color);
            margin-top: 0;
            font-size: 1.1rem;
        }

        .filter-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .filter-select {
            width: auto;
            padding: 8px 24px 8px 16px;
            font-size: 0.95rem;
            border-radius: 20px;
            border: 2px solid var(--theme-color);
            color: var(--theme-color);
            background: white;
            cursor: pointer;
            font-weight: bold;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23728FCE%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        footer {
            text-align: center;
            margin-top: 50px;
            margin-bottom: 30px;
            font-size: 0.9rem;
            color: #888;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="role-icon" id="headerIcon">ğŸ‘”</div>
        <h1 id="headerTitle">çˆ¸çˆ¸çš„å¥åº·æ—¥è¨˜</h1>
        
        <div class="role-group">
            <button class="role-btn btn-large active" onclick="setRole('çˆ¸çˆ¸')">çˆ¸çˆ¸</button>
            <button class="role-btn btn-large" onclick="setRole('åª½åª½')">åª½åª½</button>
        </div>
        <div class="role-group">
            <button class="role-btn btn-small" onclick="setRole('å¤§å¥³å…’')">å¤§å¥³å…’</button>
            <button class="role-btn btn-small" onclick="setRole('å…’å­')">å…’å­</button>
            <button class="role-btn btn-small" onclick="setRole('å°å¥³å…’')">å°å¥³å…’</button>
        </div>
    </header>

    <section class="card">
        <div class="input-group">
            <label>ğŸ“… æ¸¬é‡æ—¥æœŸ</label>
            <input type="date" id="recordDate">
        </div>

        <div class="input-group">
            <label>â° æ¸¬é‡æ™‚æ®µ</label>
            <select id="recordTime">
                <option value="æ—©ä¸Š">â˜€ï¸ æ—©ä¸Š (èµ·åºŠå¾Œ)</option>
                <option value="æ™šä¸Š">ğŸŒ™ æ™šä¸Š (ç¡å‰)</option>
            </select>
        </div>

        <div class="bp-inputs">
            <div class="input-group">
                <label>æ”¶ç¸®å£“ (é«˜)</label>
                <input type="number" id="sysVal" placeholder="120" inputmode="numeric">
            </div>
            <div class="input-group">
                <label>èˆ’å¼µå£“ (ä½)</label>
                <input type="number" id="diaVal" placeholder="80" inputmode="numeric">
            </div>
        </div>

        <button class="submit-btn" onclick="saveData()">âœ¨ è¨˜éŒ„ä»Šå¤©æ•¸å€¼</button>

        <div class="tips">
            <h3>ğŸµ å¥åº·å°è²¼å£«</h3>
            <ul style="padding-left: 20px; line-height: 1.8; color: #666;">
                <li><strong>722 åŸå‰‡ï¼š</strong>é€£çºŒ 7 å¤©ã€æ—©æ™šå„é‡ 2 æ¬¡ã€æ¯æ¬¡é‡ 2 éå–å¹³å‡ã€‚</li>
                <li>é‡æ¸¬å‰æ·±å‘¼å¸ï¼Œä¼‘æ¯ 5 åˆ†é˜ã€‚</li>
                <li><a href="https://www.hpa.gov.tw/Pages/List.aspx?nodeid=214" target="_blank" style="color:var(--theme-color)">é»æ­¤æŸ¥çœ‹è¡›ç¦éƒ¨æ›´è©³ç´°çš„è¡›æ•™è³‡è¨Š</a></li>
            </ul>
        </div>
    </section>

    <section class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 1.3rem; color: var(--theme-color); font-weight:900;">ğŸ“ˆ è¶¨å‹¢è®ŠåŒ–</h2>
            
            <div class="filter-container">
                <select id="timeRange" class="filter-select" onchange="filterAndRender()">
                    <option value="7">è¿‘ 1 é€±</option>
                    <option value="30">è¿‘ 1 å€‹æœˆ</option>
                    <option value="90">è¿‘ 3 å€‹æœˆ</option>
                </select>
            </div>
        </div>

        <div style="height: 300px; width: 100%;">
            <canvas id="bpChart"></canvas>
        </div>

        <div id="analysisResult" style="margin-top: 20px; padding: 20px; background: #F8F9FA; border-radius: 16px; border: 2px solid #E9ECEF;">
            <p style="text-align: center; color: #999;">â˜ï¸ è³‡æ–™è®€å–ä¸­...</p>
        </div>
    </section>

    <footer>
        Designed with â¤ï¸ for Family
    </footer>
</div>

<script>
    // ==========================================
    // âš ï¸ è¨˜å¾—æŠŠé€™è£¡æ›å›æ‚¨çš„ Zeabur API ç¶²å€ï¼
    // ==========================================
    const API_BASE_URL = 'https://family-health.zeabur.app/api/records'; 

    const ROLE_THEMES = {
        'çˆ¸çˆ¸': { color: '#728FCE', icon: 'ğŸ‘”', title: 'çˆ¸çˆ¸çš„å¥åº·æ—¥è¨˜' },
        'åª½åª½': { color: '#E5989B', icon: 'ğŸŒ¸', title: 'åª½åª½çš„å¥åº·æ—¥è¨˜' },
        'å¤§å¥³å…’': { color: '#F4D35E', icon: 'ğŸ€', title: 'å¤§å¥³å…’çš„ç´€éŒ„' },
        'å…’å­': { color: '#83BCA9', icon: 'ğŸ§¢', title: 'å…’å­çš„ç´€éŒ„' },
        'å°å¥³å…’': { color: '#B79CED', icon: 'ğŸ§¸', title: 'å°å¥³å…’çš„ç´€éŒ„' }
    };

    let currentRole = 'çˆ¸çˆ¸';
    let allData = []; 
    let myChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('recordDate').valueAsDate = new Date();
        applyTheme('çˆ¸çˆ¸');
        fetchData();
    });

    function setRole(role) {
        currentRole = role;
        applyTheme(role);
        fetchData();
    }

    function applyTheme(role) {
        const theme = ROLE_THEMES[role];
        const root = document.documentElement;
        root.style.setProperty('--theme-color', theme.color);
        document.getElementById('headerIcon').innerText = theme.icon;
        document.getElementById('headerTitle').innerText = theme.title;
        
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.innerText === role) btn.classList.add('active');
        });
    }

    async function saveData() {
        const date = document.getElementById('recordDate').value;
        const time = document.getElementById('recordTime').value;
        const sys = document.getElementById('sysVal').value;
        const dia = document.getElementById('diaVal').value;
        const btn = document.querySelector('.submit-btn');

        if(!sys || !dia) {
            alert('è¨˜å¾—è¼¸å…¥æ•¸å€¼å–”ï¼');
            return;
        }

        btn.innerText = 'ğŸˆ åŠªåŠ›å¯«å…¥ä¸­...';
        btn.disabled = true;

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: currentRole, date, time, sys, dia })
            });

            if (!response.ok) throw new Error('Error');

            alert('âœ… ç´€éŒ„å®Œæˆï¼');
            document.getElementById('sysVal').value = '';
            document.getElementById('diaVal').value = '';
            fetchData(); 

        } catch (error) {
            alert('âŒ ç³Ÿç³•ï¼Œç¶²è·¯æœ‰é»å•é¡Œ');
        } finally {
            btn.innerText = 'âœ¨ è¨˜éŒ„ä»Šå¤©æ•¸å€¼';
            btn.disabled = false;
        }
    }

    async function fetchData() {
        const analysisDiv = document.getElementById('analysisResult');
        analysisDiv.innerHTML = '<p style="text-align:center;">â˜ï¸ è³‡æ–™è®€å–ä¸­...</p>';

        try {
            const response = await fetch(`${API_BASE_URL}?name=${encodeURIComponent(currentRole)}`);
            if (!response.ok) throw new Error('Fetch error');

            allData = await response.json();
            filterAndRender();

        } catch (error) {
            console.error(error);
            analysisDiv.innerHTML = '<p>ç„¡æ³•è®€å–è³‡æ–™ã€‚</p>';
        }
    }

    function filterAndRender() {
        const range = parseInt(document.getElementById('timeRange').value);
        const now = new Date();
        const cutoffDate = new Date();
        cutoffDate.setDate(now.getDate() - range);

        const filteredData = allData.filter(d => {
            const recordDate = new Date(d.date);
            return recordDate >= cutoffDate;
        });

        const displayData = filteredData.length > 0 ? filteredData : allData.slice(-range); 
        renderChart(displayData);
        analyzeHealth(displayData);
    }

    function renderChart(data) {
        const ctx = document.getElementById('bpChart').getContext('2d');
        const theme = ROLE_THEMES[currentRole];

        if(data.length === 0) {
            if(myChart) myChart.destroy();
            return;
        }

        const labels = data.map(d => {
            const dateObj = new Date(d.date);
            if (isNaN(dateObj.getTime())) return d.date; 
            return `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
        });
        
        const sysData = data.map(d => d.sys);
        const diaData = data.map(d => d.dia);

        if(myChart) myChart.destroy();

        Chart.defaults.font.family = "'Kiwi Maru', 'Microsoft JhengHei'";
        Chart.defaults.color = '#666';

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ”¶ç¸®å£“',
                        data: sysData,
                        borderColor: theme.color,
                        backgroundColor: theme.color, 
                        pointBackgroundColor: '#fff',
                        pointBorderColor: theme.color,
                        pointBorderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        borderWidth: 3,
                        tension: 0.4,
                    },
                    {
                        label: 'èˆ’å¼µå£“',
                        data: diaData,
                        borderColor: '#A0A0A0', 
                        borderDash: [6, 6],
                        pointRadius: 0,
                        borderWidth: 2,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { usePointStyle: true, boxWidth: 10, padding: 20 }
                    }
                },
                scales: {
                    x: { 
                        grid: { display: false },
                        ticks: { font: { weight: 'bold' } }
                    }, 
                    y: { 
                        beginAtZero: false, 
                        grid: { color: '#E0E0E0', borderDash: [2, 2] },
                        suggestedMin: 60,
                        suggestedMax: 160
                    }
                }
            }
        });
    }

    function analyzeHealth(data) {
        if (!data || data.length === 0) {
            document.getElementById('analysisResult').innerHTML = '<p>ç›®å‰å€é–“ç„¡è³‡æ–™ã€‚</p>';
            return;
        }

        let totalSys = 0, totalDia = 0;
        data.forEach(d => {
            totalSys += parseInt(d.sys);
            totalDia += parseInt(d.dia);
        });
        const avgSys = Math.round(totalSys / data.length);
        const avgDia = Math.round(totalDia / data.length);

        let status = 'æ­£å¸¸';
        let color = '#83BCA9'; 
        let advice = 'å¾ˆæ£’å–”ï¼ç¹¼çºŒä¿æŒå¹³éœçš„å¿ƒæƒ…ã€‚';

        if (avgSys >= 130 || avgDia >= 80) {
            status = 'æ³¨æ„';
            color = '#F4D35E'; 
            advice = 'ç¨å¾®åé«˜å›‰ï¼Œé€™å¹¾å¤©è¨˜å¾—å°‘åƒé¹¹çš„ã€‚';
        }
        if (avgSys >= 140 || avgDia >= 90) {
            status = 'éé«˜';
            color = '#E5989B';
            advice = 'è¡€å£“æœ‰é»é«˜ï¼Œå»ºè­°æ‰¾é†«ç”ŸèŠèŠå–”ã€‚';
        }

        document.getElementById('analysisResult').innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="margin:0; color: ${color}; font-size:1.4rem;">å¹³å‡ ${avgSys} / ${avgDia}</h3>
                    <small style="color: #888; font-weight:bold;">${document.getElementById('timeRange').selectedOptions[0].text}å¹³å‡å€¼</small>
                </div>
                <span class="status-badge" style="background-color: ${color}; font-size:1rem; padding:8px 16px;">${status}</span>
            </div>
            <hr style="border: 0; border-top: 2px dashed #ddd; margin: 15px 0;">
            <p style="margin:0; color: #555; font-size:1rem; line-height:1.6;">ğŸ“ ${advice}</p>
        `;
    }
</script>

</body>
</html>